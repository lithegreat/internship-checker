name: Daily Internship Check

on:
  schedule:
    - cron: '0 8 * * *'   # Runs every day at 08:00 UTC (10:00 in Germany during summer)
  workflow_dispatch:       # Allow manual run

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out repo
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Run script
      - name: Run internship checker
        run: python check_internships.py

      # 5. Check if internships file was updated
      - name: Check for changes in internships file
        id: check-changes
        run: |
          if git diff --name-only | grep -q "published_internships.txt"; then
            echo "file_changed=true" >> $GITHUB_OUTPUT
            echo "Internships file was updated"
          else
            echo "file_changed=false" >> $GITHUB_OUTPUT
            echo "No changes to internships file"
          fi

      # 6. Download PDFs if file was updated
      - name: Download PDFs
        if: steps.check-changes.outputs.file_changed == 'true'
        continue-on-error: true  # Don't fail the workflow if downloads fail
        env:
          CI: true  # Enable CI mode for download script
        run: |
          echo "Internships file was updated, downloading PDFs..."
          echo "Testing network connectivity..."
          ping -c 3 tumanager.ei.tum.de || echo "Direct ping failed, but trying downloads anyway"
          python download_pdf.py || echo "Some downloads may have failed, but continuing with workflow"

      # 7. Commit and push all changes
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add published_internships.txt
          # Add downloads directory only if it exists and has files
          if [ -d "downloads" ] && [ "$(ls -A downloads)" ]; then
            git add downloads/
          fi
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update internship list and download PDFs [skip ci]"
            git push
          fi
